# AI Assistant Error Resolution Guide

## Error Report Analysis

**Error:** "AI service configuration error"  
**Date:** December 25, 2025, 9:29 PM AEST  
**Environment:** Production (rockywebstudio.com.au)

## Root Cause

The error message "AI service configuration error" is generated by this code in `app/api/ai-assistant/route.ts`:

```typescript
if (!process.env.ANTHROPIC_API_KEY) {
  console.error('[AI Assistant] ANTHROPIC_API_KEY not set');
  return NextResponse.json(
    {
      error: 'AI service configuration error',
      message: 'The AI assistant is not properly configured. Please contact support.',
    },
    { status: 500 }
  );
}
```

**This means:** `ANTHROPIC_API_KEY` is not set in your Vercel production environment.

---

## ‚úÖ Solution: 3-Step Fix

### Step 1: Get Your Claude API Key

1. Go to https://console.anthropic.com/
2. Sign in or create an account
3. Navigate to **API Keys** section
4. Click **Create Key** (or use existing key)
5. Copy the key (starts with `sk-ant-...`)

### Step 2: Add to Vercel Production

1. Go to https://vercel.com/dashboard
2. Select your project: **rocky-web-studio** (or similar)
3. Click **Settings** (top navigation)
4. Click **Environment Variables** (left sidebar)
5. Click **Add New** button
6. Fill in:
   - **Name:** `ANTHROPIC_API_KEY`
   - **Value:** Paste your API key (e.g., `sk-ant-...`)
   - **Environment:** Select all three:
     - ‚úÖ Production
     - ‚úÖ Preview  
     - ‚úÖ Development
7. Click **Save**

### Step 3: Redeploy

**Important:** Environment variables only take effect after redeployment!

1. After saving, Vercel may show a "Redeploy" button - click it
2. OR go to **Deployments** tab
3. Find your latest deployment
4. Click the three dots (‚ãØ) menu
5. Click **Redeploy**
6. Wait 1-2 minutes for deployment to complete

---

## üîç Verify Other Required Variables

While you're in Vercel Settings ‚Üí Environment Variables, verify these are also set:

### Required for AI Assistant:
- ‚úÖ `ANTHROPIC_API_KEY` - **MISSING (this is the problem)**
- ‚úÖ `NEXT_PUBLIC_SUPABASE_URL` - Should already be set
- ‚úÖ `NEXT_PUBLIC_SUPABASE_ANON_KEY` - Should already be set
- ‚úÖ `SUPABASE_SERVICE_ROLE_KEY` - Should already be set

### How to Check:
1. In Vercel ‚Üí Settings ‚Üí Environment Variables
2. Look for each variable in the list
3. If any are missing, add them
4. **Redeploy** after adding any variables

---

## üóÑÔ∏è Verify Supabase Tables

The AI Assistant stores conversations in Supabase. Verify the tables exist:

### Check in Supabase Dashboard:
1. Go to https://supabase.com/dashboard
2. Select your project
3. Go to **Table Editor**
4. Look for these tables:
   - `ai_assistant_conversations` ‚úÖ
   - `ai_assistant_messages` ‚úÖ

### If Tables Don't Exist:
1. Go to **SQL Editor** in Supabase Dashboard
2. Open file: `supabase/migrations/20250125_create_ai_assistant_tables.sql`
3. Copy the entire SQL content
4. Paste into SQL Editor
5. Click **Run**
6. Verify tables appear in Table Editor

---

## üß™ Test After Fix

Once you've added the API key and redeployed:

1. **Wait 1-2 minutes** for deployment to complete
2. **Visit your live site:** rockywebstudio.com.au
3. **Click the chat widget** (floating button bottom-right)
4. **Send a test message:** "Hello, test"
5. **Expected result:**
   - ‚úÖ No error message
   - ‚úÖ "AI is thinking..." appears briefly
   - ‚úÖ Response streams in real-time
   - ‚úÖ Message appears in chat

### If Still Not Working:

**Check Vercel Function Logs:**
1. Vercel ‚Üí Your Project ‚Üí **Functions**
2. Click on `/api/ai-assistant`
3. View **Logs** tab
4. Look for error messages

**Common Log Messages:**
- `[AI Assistant] ANTHROPIC_API_KEY not set` ‚Üí Key still not set or not redeployed
- `Claude API error: 401` ‚Üí Invalid API key
- `Claude API error: 429` ‚Üí Rate limit exceeded
- `Failed to store conversation` ‚Üí Supabase issue

---

## üìã Complete Checklist

Use this to verify everything is set up:

### Vercel Environment Variables:
- [ ] `ANTHROPIC_API_KEY` is set
- [ ] `NEXT_PUBLIC_SUPABASE_URL` is set
- [ ] `NEXT_PUBLIC_SUPABASE_ANON_KEY` is set
- [ ] `SUPABASE_SERVICE_ROLE_KEY` is set
- [ ] All variables are set for Production environment
- [ ] Project has been redeployed after adding variables

### Supabase:
- [ ] `ai_assistant_conversations` table exists
- [ ] `ai_assistant_messages` table exists
- [ ] RLS policies are enabled (migration handles this)

### Deployment:
- [ ] Latest deployment is "Ready" (green status)
- [ ] No build errors in deployment logs
- [ ] Deployment completed successfully

### Testing:
- [ ] Chat widget appears on live site
- [ ] Can send messages
- [ ] No "AI service configuration error"
- [ ] Responses appear in real-time

---

## üö® Still Having Issues?

If you've completed all steps and it's still not working:

1. **Check Vercel Logs** (most important):
   - Vercel ‚Üí Functions ‚Üí `/api/ai-assistant` ‚Üí Logs
   - Look for specific error messages
   - Share the error with support

2. **Test API Directly:**
   ```javascript
   // Run in browser console on your live site
   fetch('/api/ai-assistant', {
     method: 'POST',
     headers: { 'Content-Type': 'application/json' },
     body: JSON.stringify({
       messages: [{ role: 'user', content: 'test' }]
     })
   })
   .then(r => r.json())
   .then(console.log)
   .catch(console.error);
   ```

3. **Verify API Key:**
   - Go to https://console.anthropic.com/
   - Check API key is active
   - Verify you have available credits/quota

4. **Check Claude API Status:**
   - Visit https://status.anthropic.com/
   - Verify API is operational

---

## üìù Summary

**The Issue:** `ANTHROPIC_API_KEY` is not set in Vercel production.

**The Fix:**
1. Add `ANTHROPIC_API_KEY` to Vercel environment variables
2. Select all environments (Production, Preview, Development)
3. Redeploy the project
4. Test the chat widget

**Expected Time:** 5-10 minutes (including deployment time)

**Most Common Mistake:** Forgetting to redeploy after adding the environment variable. The variable won't be available until you redeploy!

